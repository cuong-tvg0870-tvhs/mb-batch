generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
}

// =======================
// ENUMS
// =======================
enum Role {
    ADMIN
    MANAGER
    EDITOR
}

enum AccountType {
    AD_ACCOUNT
    PAGE
    INSTAGRAM
    BUSINESS_MANAGER
}

enum MemberRole {
    OWNER
    MANAGER
    EDITOR
    VIEWER
}

/// ===============================
/// ENUMS
/// ===============================

enum Status {
    DRAFT
    ACTIVE
    PAUSED
    DELETED
    ARCHIVED
}

enum InsightRange {
    MAX
    DAY_7
    DAY_3
    DAILY
}

enum LevelInsight {
    AD
    CAMPAIGN
    ADSET
}

// =======================
// MODELS
// =======================
model TargetingInterest {
    id                        String  @id @default(uuid())
    name                      String
    description               String?
    audience_size_lower_bound Int?
    audience_size_upper_bound Int?
    path                      Json?
    topic                     String?
}

model CidContent {
    id           String  @id @default(uuid())
    code         String
    name         String
    project_name String?
    ma_sanpham   String?
    ten_sanpham  String?

    createdAt DateTime @default(now())

    @@unique([code])
    @@unique([name])
    @@index([code, name, ma_sanpham, ten_sanpham, project_name])
}

model DropdownCategory {
    id          String  @id @default(uuid())
    key         String  @unique
    name        String
    description String?

    isActive    Boolean   @default(true)
    createdAt   DateTime  @default(now())
    createdById String?
    updatedAt   DateTime  @updatedAt
    updatedById String?
    deletedAt   DateTime?

    items DropdownItem[] @relation("DropdownCategory_Items")

    @@index([key])
}

model DropdownItem {
    id          String    @id @default(uuid())
    categoryId  String
    externalId  String? // ví dụ: "LINK_CLICKS"
    name        String
    value       String?
    description String?
    color       String?
    sortOrder   Int       @default(0)
    metadata    Json?
    isDefault   Boolean   @default(false)
    isActive    Boolean   @default(true)
    createdAt   DateTime  @default(now())
    createdById String?
    updatedAt   DateTime  @updatedAt
    updatedById String?
    deletedAt   DateTime?

    category DropdownCategory @relation("DropdownCategory_Items", fields: [categoryId], references: [id])

    @@unique([categoryId, value])
    @@index([categoryId])
    @@index([externalId])
}

model User {
    id          String  @id @default(uuid())
    email       String  @unique
    employee_id String?
    name        String
    password    String
    role        Role    @default(EDITOR)

    parentId String?
    parent   User?   @relation("UserChildren", fields: [parentId], references: [id])
    children User[]  @relation("UserChildren")

    locale String?

    // relations
    changeLogs     ChangeLog[]     @relation("change_actor")
    accountMembers AccountMember[] @relation("UserAccountMembers")

    createdAt    DateTime      @default(now())
    createdById  String?
    updatedAt    DateTime      @updatedAt
    updatedById  String?
    deletedAt    DateTime?
    deletedById  String?
    userFanpages UserFanpage[]
}

model UserFanpage {
    id     String  @id @default(uuid())
    userId String
    user   User    @relation(fields: [userId], references: [id])
    pageId String // ID của Fanpage (ví dụ từ Meta)
    page   Fanpage @relation(fields: [pageId], references: [id])

    name      String? // Tên hiển thị trong dropdown
    isActive  Boolean  @default(true)
    createdAt DateTime @default(now())

    @@index([userId, pageId])
}

// [{"id": "249650921563125", "name": "Seyoul Beauty - Malaysia"}, {"id": "111534788320800", "name": "Seyoul Smooth Skin - ผิวเรียบเนียนไร้กาลเวลา"}]
model Fanpage {
    id           String        @id
    name         String?
    userFanpages UserFanpage[]
    creatives    Creative[]
}

model Account {
    // store as string to support "act_123", "page_123", "business_123"
    id            String      @id
    accountType   AccountType
    name          String?
    currency      String?
    timezone      String?
    needsReauth   Boolean     @default(false)
    lastFetchedAt DateTime?
    rawPayload    Json?
    createdAt     DateTime    @default(now())
    updatedAt     DateTime    @updatedAt

    pages  Json?
    pixels Json?

    // relations
    members         AccountMember[]  @relation("AccountAccountMembers")
    campaigns       Campaign[]
    adSets          AdSet[]
    ads             Ad[]
    creatives       Creative[]
    adImages        AdImage[]
    adVideos        AdVideo[]
    cidGroups       CidGroup[]
    systemCampaigns SystemCampaign[]
    systemAdSets    SystemAdSet[]
    systemAds       SystemAd[]
    systemCreatives SystemCreative[]

    @@index([accountType])
    @@index([needsReauth])
}

model AccountMember {
    id        String @id @default(uuid())
    accountId String
    userId    String

    account Account @relation("AccountAccountMembers", fields: [accountId], references: [id], onDelete: Cascade)
    user    User    @relation("UserAccountMembers", fields: [userId], references: [id])

    role      MemberRole
    createdAt DateTime   @default(now())

    // one membership per user per account
    @@unique([accountId, userId])
    @@index([accountId])
    @@index([userId])
}

model Campaign {
    id        String  @id // store facebook id as string, e.g. "238393..."
    accountId String
    account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

    systemCampaignId String?
    systemCampaign   SystemCampaign? @relation(fields: [systemCampaignId], references: [id], onDelete: Cascade)

    name            String?
    status          String?
    objective       String?
    buyingType      String?
    effectiveBudget Int       @default(0)
    dailyBudget     Int?
    lifetimeBudget  Int?
    startTime       DateTime?
    endTime         DateTime?
    remoteUpdatedAt DateTime?
    lastFetchedAt   DateTime?
    rawPayload      Json?

    createdAt DateTime  @default(now())
    updatedAt DateTime  @default(now())
    deletedAt DateTime?

    adsets                   AdSet[]
    ads                      Ad[]
    campaignInsights         CampaignInsight[]
    adSetInsights            AdSetInsight[]
    creativeInsights         CreativeInsight[]
    campaignAudienceInsights CampaignAudienceInsight[]

    // INSIGHT DATA
    impressions Int?   @default(0)
    reach       Int?   @default(0)
    frequency   Float? @default(0)

    /**
     * ===== TRAFFIC =====
     */
    clicks       Int?   @default(0)
    uniqueClicks Int?   @default(0)
    ctr          Float? @default(0)
    uniqueCtr    Float? @default(0)
    cpc          Float? @default(0)
    cpm          Float? @default(0)

    /**
     * ===== SPEND =====
     */
    spend Float? @default(0)

    /**
     * ===== CONVERSION =====
     */
    results       Int?   @default(0)
    costPerResult Float? @default(0)
    aov           Int?   @default(0)

    purchases     Int?   @default(0)
    purchaseValue Float? @default(0)
    roas          Float? @default(0)

    registrationComplete      Int?   @default(0)
    registrationCompleteValue Float? @default(0)
    messagingStarted          Int?   @default(0)
    messagingStartedValue     Float? @default(0)
    outboundClicks            Int?   @default(0)
    outboundClicksValue       Float? @default(0)

    cvr          Float? @default(0)
    adsCostRatio Float? @default(0)

    qualityRanking        String?
    engagementRateRanking String?
    conversionRateRanking String?

    /**
     * ===== RAW =====
     */
    actions      Json?
    actionValues Json?

    videoPlay Float? @default(0)
    video3s   Float? @default(0)
    video100  Float? @default(0)

    videoAvgWatchTime Float? @default(0)
    videoThruplay     Int?   @default(0)
    videoView         Int?   @default(0)

    hookRate Float? @default(0)
    holdRate Float? @default(0)

    @@unique([id, systemCampaignId])
    @@index([accountId])
    @@index([status])
    @@index([remoteUpdatedAt])
}

model AdSet {
    id         String   @id
    campaignId String
    campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

    accountId String
    account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

    name   String?
    status String?

    optimizationGoal String?
    billingEvent     String?
    bidStrategy      String?

    effectiveBudget Int  @default(0)
    dailyBudget     Int?
    lifetimeBudget  Int?

    targeting       Json?
    startTime       DateTime?
    endTime         DateTime?
    remoteUpdatedAt DateTime?

    lastFetchedAt DateTime?
    rawPayload    Json?

    ads Ad[]

    createdAt     DateTime       @default(now())
    updatedAt     DateTime       @default(now())
    deletedAt     DateTime?
    adSetInsights AdSetInsight[]

    // INSIGHT
    // INSIGHT DATA
    impressions Int?   @default(0)
    reach       Int?   @default(0)
    frequency   Float? @default(0)

    /**
     * ===== TRAFFIC =====
     */
    clicks       Int?   @default(0)
    uniqueClicks Int?   @default(0)
    ctr          Float? @default(0)
    uniqueCtr    Float? @default(0)
    cpc          Float? @default(0)
    cpm          Float? @default(0)

    /**
     * ===== SPEND =====
     */
    spend Float? @default(0)

    /**
     * ===== CONVERSION =====
     */
    results       Int?   @default(0)
    costPerResult Float? @default(0)
    aov           Int?   @default(0)

    purchases     Int?   @default(0)
    purchaseValue Float? @default(0)
    roas          Float? @default(0)

    registrationComplete      Int?   @default(0)
    registrationCompleteValue Float? @default(0)
    messagingStarted          Int?   @default(0)
    messagingStartedValue     Float? @default(0)
    outboundClicks            Int?   @default(0)
    outboundClicksValue       Float? @default(0)

    cvr          Float? @default(0)
    adsCostRatio Float? @default(0)

    qualityRanking        String?
    engagementRateRanking String?
    conversionRateRanking String?

    /**
     * ===== RAW =====
     */
    actions      Json?
    actionValues Json?

    videoPlay Float? @default(0)
    video3s   Float? @default(0)
    video100  Float? @default(0)

    videoAvgWatchTime Float? @default(0)
    videoThruplay     Int?   @default(0)
    videoView         Int?   @default(0)

    hookRate              Float?                 @default(0)
    holdRate              Float?                 @default(0)
    adsetAudienceInsights AdsetAudienceInsight[]

    @@index([campaignId])
    @@index([accountId])
    @@index([status])
}

model Ad {
    id String @id

    adsetId String
    adset   AdSet  @relation(fields: [adsetId], references: [id], onDelete: Cascade)

    cid      String?
    cidGroup CidGroup? @relation(fields: [cid], references: [cid], onDelete: Cascade)

    campaignId String?
    campaign   Campaign? @relation(fields: [campaignId], references: [id])

    accountId String?
    account   Account? @relation(fields: [accountId], references: [id])

    name             String?
    status           String?
    effectiveStatus  String?
    configuredStatus String?
    creativeId       String?
    creative         Creative?   @relation(fields: [creativeId], references: [id])
    remoteUpdatedAt  DateTime?
    lastFetchedAt    DateTime?
    rawPayload       Json?
    adInsights       AdInsight[]

    createdAt DateTime  @default(now())
    updatedAt DateTime  @default(now())
    deletedAt DateTime?

    // INSIGHT
    // INSIGHT DATA
    impressions Int?   @default(0)
    reach       Int?   @default(0)
    frequency   Float? @default(0)

    /**
     * ===== TRAFFIC =====
     */
    clicks       Int?   @default(0)
    uniqueClicks Int?   @default(0)
    ctr          Float? @default(0)
    uniqueCtr    Float? @default(0)
    cpc          Float? @default(0)
    cpm          Float? @default(0)

    /**
     * ===== SPEND =====
     */
    spend Float? @default(0)

    /**
     * ===== CONVERSION =====
     */
    results       Int?   @default(0)
    costPerResult Float? @default(0)
    aov           Int?   @default(0)

    purchases     Int?   @default(0)
    purchaseValue Float? @default(0)
    roas          Float? @default(0)

    registrationComplete      Int?   @default(0)
    registrationCompleteValue Float? @default(0)
    messagingStarted          Int?   @default(0)
    messagingStartedValue     Float? @default(0)
    outboundClicks            Int?   @default(0)
    outboundClicksValue       Float? @default(0)

    cvr          Float? @default(0)
    adsCostRatio Float? @default(0)

    qualityRanking        String?
    engagementRateRanking String?
    conversionRateRanking String?

    /**
     * ===== RAW =====
     */
    actions      Json?
    actionValues Json?

    videoPlay Float? @default(0)
    video3s   Float? @default(0)
    video100  Float? @default(0)

    videoAvgWatchTime Float? @default(0)
    videoThruplay     Int?   @default(0)
    videoView         Int?   @default(0)

    hookRate           Float?              @default(0)
    holdRate           Float?              @default(0)
    adAudienceInsights AdAudienceInsight[]

    @@index([adsetId])
    @@index([creativeId])
    @@index([accountId])
    @@index([status])
}

enum CidStatus {
    TEST
    NEED_TO_SPEND
    SCALE_P1
    SCALE_P2
    REVIEW
    OFF
}

model CidGroup {
    id  String @id @default(uuid())
    cid String @unique
    ads Ad[]

    accountId String?
    account   Account? @relation(fields: [accountId], references: [id])

    name        String?
    description String?

    spentMax    Float?
    spent7d     Float?
    spent3d     Float?
    roasMax     Float?
    roas7d      Float?
    roas3d      Float?
    ctrMax      Float?
    purchaseMax Float?

    status        CidStatus? // Test / Need to Spend / Scale P1 / Scale P2 / Review / Off
    lastUpdatedAt DateTime?
    lastPushedAt  DateTime?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([accountId])
    @@index([status])
    @@index([cid])
    @@map("CID")
}

model Creative {
    id String @id

    adId String? // optional backref id if you want link from ad->creative
    ads  Ad[]

    accountId String?
    account   Account? @relation(fields: [accountId], references: [id])

    pageId String?

    systemPageId String?
    page         Fanpage? @relation(fields: [systemPageId], references: [id])

    postId              String?
    objectStoryId       String?
    effectObjectStoryId String?
    name                String?
    creativeType        String? // IMAGE, VIDEO, CAROUSEL, LINK, ...

    imageHash String?
    adImage   AdImage? @relation(fields: [imageHash], references: [hash])

    imageUrl     String?
    thumbnailUrl String?

    previewUrl      String?
    remoteUpdatedAt DateTime?
    lastFetchedAt   DateTime?
    rawPayload      Json?
    createdAt       DateTime  @default(now())
    updatedAt       DateTime  @default(now())

    videoId          String?
    adVideo          AdVideo?          @relation(fields: [videoId], references: [id])
    creativeInsights CreativeInsight[]

    // INSIGHT DATA
    // INSIGHT DATA
    impressions Int?   @default(0)
    reach       Int?   @default(0)
    frequency   Float? @default(0)

    /**
     * ===== TRAFFIC =====
     */
    clicks       Int?   @default(0)
    uniqueClicks Int?   @default(0)
    ctr          Float? @default(0)
    uniqueCtr    Float? @default(0)
    cpc          Float? @default(0)
    cpm          Float? @default(0)

    /**
     * ===== SPEND =====
     */
    spend Float? @default(0)

    /**
     * ===== CONVERSION =====
     */
    results       Int?   @default(0)
    costPerResult Float? @default(0)
    aov           Int?   @default(0)

    purchases     Int?   @default(0)
    purchaseValue Float? @default(0)
    roas          Float? @default(0)

    /**
     * ===== QUALITY =====
     */
    qualityRanking        String?
    engagementRateRanking String?
    conversionRateRanking String?

    /**
     * ===== RAW =====
     */
    actions      Json?
    actionValues Json?

    registrationComplete      Int?   @default(0)
    registrationCompleteValue Float? @default(0)
    messagingStarted          Int?   @default(0)
    messagingStartedValue     Float? @default(0)
    outboundClicks            Int?   @default(0)
    outboundClicksValue       Float? @default(0)

    cvr          Float? @default(0)
    adsCostRatio Float? @default(0)

    videoAvgWatchTime Float? @default(0)
    videoThruplay     Int?   @default(0)
    videoView         Int?   @default(0)

    @@index([accountId])
    @@index([imageHash])
    @@index([videoId])
}

model AdImage {
    id        String  @id @default(uuid())
    accountId String
    account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

    hash          String
    name          String?
    url           String?
    permalink_url String?
    width         Int?
    height        Int?

    status      String?
    createdTime DateTime?
    rawPayload  Json?

    createdAt DateTime @default(now())
    updatedAt DateTime @default(now())

    creatives Creative[]

    @@unique([accountId, hash, id])
    @@unique([hash])
    @@index([accountId])
    @@index([hash])
}

model AdVideo {
    id        String  @id // Meta video_id
    accountId String
    account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

    title       String?
    source      String?
    description String?
    status      String? // READY, PROCESSING, ERROR
    length      Int? // seconds

    thumbnailUrl String?

    remoteCreatedAt DateTime?
    remoteUpdatedAt DateTime?
    lastFetchedAt   DateTime?

    rawPayload Json?

    createdTime DateTime?

    createdAt DateTime   @default(now())
    updatedAt DateTime   @default(now())
    creatives Creative[]

    @@index([status])
    @@index([accountId])
}

model AdInsight {
    id String @id @default(cuid())

    adId String
    ad   Ad     @relation(fields: [adId], references: [id], onDelete: Cascade)

    level LevelInsight @default(AD)

    dateStart   String
    dateStop    String
    range       InsightRange @default(DAILY)
    // INSIGHT DATA
    impressions Int?         @default(0)
    reach       Int?         @default(0)
    frequency   Float?       @default(0)

    /**
     * ===== TRAFFIC =====
     */
    clicks       Int?   @default(0)
    uniqueClicks Int?   @default(0)
    ctr          Float? @default(0)
    uniqueCtr    Float? @default(0)
    cpc          Float? @default(0)
    cpm          Float? @default(0)

    /**
     * ===== SPEND =====
     */
    spend Float? @default(0)

    /**
     * ===== CONVERSION =====
     */
    results       Int?   @default(0)
    costPerResult Float? @default(0)
    aov           Int?   @default(0)

    purchases     Int?   @default(0)
    purchaseValue Float? @default(0)
    roas          Float? @default(0)

    registrationComplete      Int?   @default(0)
    registrationCompleteValue Float? @default(0)
    messagingStarted          Int?   @default(0)
    messagingStartedValue     Float? @default(0)
    outboundClicks            Int?   @default(0)
    outboundClicksValue       Float? @default(0)

    cvr          Float? @default(0)
    adsCostRatio Float? @default(0)

    qualityRanking        String?
    engagementRateRanking String?
    conversionRateRanking String?

    /**
     * ===== RAW =====
     */
    actions      Json?
    actionValues Json?

    videoPlay Float? @default(0)
    video3s   Float? @default(0)
    video100  Float? @default(0)

    videoAvgWatchTime Float? @default(0)
    videoThruplay     Int?   @default(0)
    videoView         Int?   @default(0)

    hookRate   Float? @default(0)
    holdRate   Float? @default(0)
    rawPayload Json?

    createdAt DateTime @default(now())
    updatedAt DateTime @default(now())

    @@unique([adId, dateStart, range])
    @@index([adId])
}

model CampaignInsight {
    id String @id @default(cuid())

    campaignId String
    campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

    level LevelInsight @default(CAMPAIGN)

    dateStart String
    dateStop  String
    range     InsightRange @default(DAILY)

    // INSIGHT DATA
    impressions Int?   @default(0)
    reach       Int?   @default(0)
    frequency   Float? @default(0)

    /**
     * ===== TRAFFIC =====
     */
    clicks       Int?   @default(0)
    uniqueClicks Int?   @default(0)
    ctr          Float? @default(0)
    uniqueCtr    Float? @default(0)
    cpc          Float? @default(0)
    cpm          Float? @default(0)

    /**
     * ===== SPEND =====
     */
    spend Float? @default(0)

    /**
     * ===== CONVERSION =====
     */
    results       Int?   @default(0)
    costPerResult Float? @default(0)
    aov           Int?   @default(0)

    purchases     Int?   @default(0)
    purchaseValue Float? @default(0)
    roas          Float? @default(0)

    registrationComplete      Int?   @default(0)
    registrationCompleteValue Float? @default(0)
    messagingStarted          Int?   @default(0)
    messagingStartedValue     Float? @default(0)
    outboundClicks            Int?   @default(0)
    outboundClicksValue       Float? @default(0)

    cvr          Float? @default(0)
    adsCostRatio Float? @default(0)

    qualityRanking        String?
    engagementRateRanking String?
    conversionRateRanking String?

    /**
     * ===== RAW =====
     */
    actions      Json?
    actionValues Json?

    videoPlay Float? @default(0)
    video3s   Float? @default(0)
    video100  Float? @default(0)

    videoAvgWatchTime Float? @default(0)
    videoThruplay     Int?   @default(0)
    videoView         Int?   @default(0)

    hookRate Float? @default(0)
    holdRate Float? @default(0)

    rawPayload Json?

    createdAt DateTime @default(now())
    updatedAt DateTime @default(now())

    @@unique([campaignId, dateStart, range])
    @@index([campaignId])
    @@index([dateStart, dateStop])
}

model CreativeInsight {
    id String @id @default(cuid())

    creativeId String
    creative   Creative @relation(fields: [creativeId], references: [id], onDelete: Cascade)

    level LevelInsight @default(AD)

    dateStart String
    dateStop  String
    range     InsightRange @default(DAILY)

    // INSIGHT DATA
    impressions Int?   @default(0)
    reach       Int?   @default(0)
    frequency   Float? @default(0)

    /**
     * ===== TRAFFIC =====
     */
    clicks       Int?   @default(0)
    uniqueClicks Int?   @default(0)
    ctr          Float? @default(0)
    uniqueCtr    Float? @default(0)
    cpc          Float? @default(0)
    cpm          Float? @default(0)

    /**
     * ===== SPEND =====
     */
    spend Float? @default(0)

    /**
     * ===== CONVERSION =====
     */
    results       Int?   @default(0)
    costPerResult Float? @default(0)
    aov           Int?   @default(0)

    purchases     Int?   @default(0)
    purchaseValue Float? @default(0)
    roas          Float? @default(0)

    registrationComplete      Int?   @default(0)
    registrationCompleteValue Float? @default(0)
    messagingStarted          Int?   @default(0)
    messagingStartedValue     Float? @default(0)
    outboundClicks            Int?   @default(0)
    outboundClicksValue       Float? @default(0)

    cvr          Float? @default(0)
    adsCostRatio Float? @default(0)

    qualityRanking        String?
    engagementRateRanking String?
    conversionRateRanking String?

    /**
     * ===== RAW =====
     */
    actions      Json?
    actionValues Json?

    videoPlay Float? @default(0)
    video3s   Float? @default(0)
    video100  Float? @default(0)

    videoAvgWatchTime Float? @default(0)
    videoThruplay     Int?   @default(0)
    videoView         Int?   @default(0)

    hookRate   Float? @default(0)
    holdRate   Float? @default(0)
    rawPayload Json?

    createdAt  DateTime  @default(now())
    updatedAt  DateTime  @default(now())
    campaign   Campaign? @relation(fields: [campaignId], references: [id])
    campaignId String?

    @@unique([creativeId, dateStart, range])
    @@index([creativeId])
}

model AdSetInsight {
    id String @id @default(cuid())

    adSetId String
    adSet   AdSet  @relation(fields: [adSetId], references: [id], onDelete: Cascade)

    level LevelInsight @default(ADSET)

    dateStart String
    dateStop  String
    range     InsightRange @default(DAILY)

    // INSIGHT DATA
    impressions Int?   @default(0)
    reach       Int?   @default(0)
    frequency   Float? @default(0)

    /**
     * ===== TRAFFIC =====
     */
    clicks       Int?   @default(0)
    uniqueClicks Int?   @default(0)
    ctr          Float? @default(0)
    uniqueCtr    Float? @default(0)
    cpc          Float? @default(0)
    cpm          Float? @default(0)

    /**
     * ===== SPEND =====
     */
    spend Float? @default(0)

    /**
     * ===== CONVERSION =====
     */
    results       Int?   @default(0)
    aov           Int?   @default(0)
    costPerResult Float? @default(0)

    purchases     Int?   @default(0)
    purchaseValue Float? @default(0)
    roas          Float? @default(0)

    registrationComplete      Int?   @default(0)
    registrationCompleteValue Float? @default(0)
    messagingStarted          Int?   @default(0)
    messagingStartedValue     Float? @default(0)
    outboundClicks            Int?   @default(0)
    outboundClicksValue       Float? @default(0)
    cvr                       Float? @default(0)
    adsCostRatio              Float? @default(0)

    qualityRanking        String?
    engagementRateRanking String?
    conversionRateRanking String?

    /**
     * ===== RAW =====
     */
    actions      Json?
    actionValues Json?

    videoPlay Float? @default(0)
    video3s   Float? @default(0)
    video100  Float? @default(0)

    videoAvgWatchTime Float? @default(0)
    videoThruplay     Int?   @default(0)
    videoView         Int?   @default(0)

    hookRate Float? @default(0)
    holdRate Float? @default(0)

    rawPayload Json?

    createdAt  DateTime  @default(now())
    updatedAt  DateTime  @default(now())
    campaign   Campaign? @relation(fields: [campaignId], references: [id])
    campaignId String?

    @@unique([adSetId, dateStart, range])
    @@index([adSetId])
}

model CampaignAudienceInsight {
    id String @id @default(cuid())

    campaignId String
    campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

    level LevelInsight @default(CAMPAIGN)

    /**
     * ===== TIME =====
     * Không theo ngày → dùng ALL_TIME
     * Nhưng vẫn giữ field để mở rộng
     */
    dateStart String?
    dateStop  String?
    range     InsightRange @default(MAX)

    /**
     * ===== BREAKDOWN =====
     */
    age    String // e.g. "18-24", "25-34"
    gender String // "male" | "female" | "unknown"

    // INSIGHT DATA
    impressions Int?   @default(0)
    reach       Int?   @default(0)
    frequency   Float? @default(0)

    /**
     * ===== TRAFFIC =====
     */
    clicks       Int?   @default(0)
    uniqueClicks Int?   @default(0)
    ctr          Float? @default(0)
    uniqueCtr    Float? @default(0)
    cpc          Float? @default(0)
    cpm          Float? @default(0)

    /**
     * ===== SPEND =====
     */
    spend Float? @default(0)

    /**
     * ===== CONVERSION =====
     */
    results       Int?   @default(0)
    costPerResult Float? @default(0)
    aov           Int?   @default(0)

    purchases     Int?   @default(0)
    purchaseValue Float? @default(0)
    roas          Float? @default(0)

    registrationComplete      Int?   @default(0)
    registrationCompleteValue Float? @default(0)
    messagingStarted          Int?   @default(0)
    messagingStartedValue     Float? @default(0)
    outboundClicks            Int?   @default(0)
    outboundClicksValue       Float? @default(0)

    cvr          Float? @default(0)
    adsCostRatio Float? @default(0)

    qualityRanking        String?
    engagementRateRanking String?
    conversionRateRanking String?

    /**
     * ===== RAW =====
     */
    actions      Json?
    actionValues Json?

    videoPlay Float? @default(0)
    video3s   Float? @default(0)
    video100  Float? @default(0)

    videoAvgWatchTime Float? @default(0)
    videoThruplay     Int?   @default(0)
    videoView         Int?   @default(0)

    hookRate Float? @default(0)
    holdRate Float? @default(0)

    rawPayload Json?

    createdAt DateTime @default(now())
    updatedAt DateTime @default(now())

    /**
     * ===== CONSTRAINT =====
     */
    @@unique([campaignId, age, gender, range])
    @@index([campaignId])
    @@index([age, gender])
}

model AdsetAudienceInsight {
    id String @id @default(cuid())

    adsetId String
    adset   AdSet  @relation(fields: [adsetId], references: [id], onDelete: Cascade)

    level LevelInsight @default(ADSET)

    /**
     * ===== TIME =====
     * Không theo ngày → dùng ALL_TIME
     * Nhưng vẫn giữ field để mở rộng
     */
    dateStart String?
    dateStop  String?
    range     InsightRange @default(MAX)

    /**
     * ===== BREAKDOWN =====
     */
    age    String // e.g. "18-24", "25-34"
    gender String // "male" | "female" | "unknown"

    // INSIGHT DATA
    impressions Int?   @default(0)
    reach       Int?   @default(0)
    frequency   Float? @default(0)

    /**
     * ===== TRAFFIC =====
     */
    clicks       Int?   @default(0)
    uniqueClicks Int?   @default(0)
    ctr          Float? @default(0)
    uniqueCtr    Float? @default(0)
    cpc          Float? @default(0)
    cpm          Float? @default(0)

    /**
     * ===== SPEND =====
     */
    spend Float? @default(0)

    /**
     * ===== CONVERSION =====
     */
    results       Int?   @default(0)
    costPerResult Float? @default(0)
    aov           Int?   @default(0)

    purchases     Int?   @default(0)
    purchaseValue Float? @default(0)
    roas          Float? @default(0)

    registrationComplete      Int?   @default(0)
    registrationCompleteValue Float? @default(0)
    messagingStarted          Int?   @default(0)
    messagingStartedValue     Float? @default(0)
    outboundClicks            Int?   @default(0)
    outboundClicksValue       Float? @default(0)

    cvr          Float? @default(0)
    adsCostRatio Float? @default(0)

    qualityRanking        String?
    engagementRateRanking String?
    conversionRateRanking String?

    /**
     * ===== RAW =====
     */
    actions      Json?
    actionValues Json?

    videoPlay Float? @default(0)
    video3s   Float? @default(0)
    video100  Float? @default(0)

    videoAvgWatchTime Float? @default(0)
    videoThruplay     Int?   @default(0)
    videoView         Int?   @default(0)

    hookRate Float? @default(0)
    holdRate Float? @default(0)

    rawPayload Json?

    createdAt DateTime @default(now())
    updatedAt DateTime @default(now())

    /**
     * ===== CONSTRAINT =====
     */
    @@unique([adsetId, age, gender, level, range, dateStart])
    @@index([adsetId])
    @@index([age, gender])
}

model AdAudienceInsight {
    id String @id @default(cuid())

    adId String
    ad   Ad     @relation(fields: [adId], references: [id], onDelete: Cascade)

    level LevelInsight @default(AD)

    /**
     * ===== TIME =====
     * Không theo ngày → dùng ALL_TIME
     * Nhưng vẫn giữ field để mở rộng
     */
    dateStart String?
    dateStop  String?
    range     InsightRange @default(MAX)

    /**
     * ===== BREAKDOWN =====
     */
    age    String // e.g. "18-24", "25-34"
    gender String // "male" | "female" | "unknown"

    // INSIGHT DATA
    impressions Int?   @default(0)
    reach       Int?   @default(0)
    frequency   Float? @default(0)

    /**
     * ===== TRAFFIC =====
     */
    clicks       Int?   @default(0)
    uniqueClicks Int?   @default(0)
    ctr          Float? @default(0)
    uniqueCtr    Float? @default(0)
    cpc          Float? @default(0)
    cpm          Float? @default(0)

    /**
     * ===== SPEND =====
     */
    spend Float? @default(0)

    /**
     * ===== CONVERSION =====
     */
    results       Int?   @default(0)
    costPerResult Float? @default(0)
    aov           Int?   @default(0)

    purchases     Int?   @default(0)
    purchaseValue Float? @default(0)
    roas          Float? @default(0)

    registrationComplete      Int?   @default(0)
    registrationCompleteValue Float? @default(0)
    messagingStarted          Int?   @default(0)
    messagingStartedValue     Float? @default(0)
    outboundClicks            Int?   @default(0)
    outboundClicksValue       Float? @default(0)

    cvr          Float? @default(0)
    adsCostRatio Float? @default(0)

    qualityRanking        String?
    engagementRateRanking String?
    conversionRateRanking String?

    /**
     * ===== RAW =====
     */
    actions      Json?
    actionValues Json?

    videoPlay Float? @default(0)
    video3s   Float? @default(0)
    video100  Float? @default(0)

    videoAvgWatchTime Float? @default(0)
    videoThruplay     Int?   @default(0)
    videoView         Int?   @default(0)

    hookRate Float? @default(0)
    holdRate Float? @default(0)

    rawPayload Json?

    createdAt DateTime @default(now())
    updatedAt DateTime @default(now())

    /**
     * ===== CONSTRAINT =====
     */
    @@unique([adId, age, gender, level, range, dateStart])
    @@index([adId])
    @@index([age, gender])
}

model ChangeLog {
    id         String   @id @default(uuid())
    actorId    String
    actor      User     @relation("change_actor", fields: [actorId], references: [id])
    action     String
    targetType String?
    targetId   String?
    diff       Json?
    createdAt  DateTime @default(now())

    @@index([actorId])
    @@index([targetType, targetId])
}

// --- MODELS ---
model TemplateCampaign {
    id   String @id @default(cuid())
    name String
    data Json?

    reference_id String?

    createdById String?
    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt
    deletedAt   DateTime?
}

model SystemCampaign {
    id      String  @id @default(cuid())
    data    Json?
    meta_id String?
    cid     String?

    status Status @default(DRAFT)

    createdById String?
    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt
    deletedAt   DateTime?

    accountId String?
    account   Account?      @relation(fields: [accountId], references: [id])
    ad_sets   SystemAdSet[]

    is_template Boolean? @default(false)

    campaign_name        String?
    campaign_objective   String?
    campaign_budgetType  String?
    campaign_budget      Int?
    campaign_bidStrategy String?
    campaign_bidAmount   Int?
    campaign_CBO         Boolean?
    campaigns            Campaign[]
}

model SystemAdSet {
    id      String  @id @default(cuid())
    data    Json?
    meta_id String?

    status Status @default(DRAFT)

    createdById String?
    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt
    deletedAt   DateTime?

    campaignId String?
    campaign   SystemCampaign? @relation(fields: [campaignId], references: [id])

    accountId String?
    account   Account? @relation(fields: [accountId], references: [id])

    ads SystemAd[]

    adset_name         String?
    adset_optimization String?
    adset_budgetType   String?
    adset_budget       Int?
    adset_bidStrategy  String?
    adset_bidAmount    Int?
}

model SystemAd {
    id      String  @id @default(cuid())
    data    Json?
    meta_id String?

    status Status @default(DRAFT)

    createdById String?
    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt
    deletedAt   DateTime?

    adSetId String?
    adSet   SystemAdSet? @relation(fields: [adSetId], references: [id])

    accountId String?
    account   Account?         @relation(fields: [accountId], references: [id])
    creative  SystemCreative[]
}

model SystemCreative {
    id   String @id @default(cuid())
    data Json?

    url_json Json?

    meta_id String?

    status Status @default(DRAFT)

    createdById String?
    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt
    deletedAt   DateTime?

    adId String?
    ad   SystemAd? @relation(fields: [adId], references: [id])

    accountId String?
    account   Account? @relation(fields: [accountId], references: [id])
}

model Planning {
    id          String  @id @default(cuid())
    name        String
    description String?

    type    PlanningType
    enabled Boolean      @default(true)

    schedule Json // { every: 5, unit: "minute" } | { cron: "0 */6 * * *" }

    config Json // type-specific config

    status PlanningStatus @default(IDLE)

    lastRunAt DateTime?
    nextRunAt DateTime?

    createdById String
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt
}

enum PlanningType {
    SYNC_CAMPAIGN
    SYNC_INSIGHT
    RULE_CAMPAIGN
}

enum PlanningStatus {
    IDLE
    WAITING
    RUNNING
    FAILED
}
